# ======================================
# MAKEFILE - CHATWOOT DOCKER DEPLOY
# ======================================

.PHONY: help build deploy quick-deploy logs shell db-migrate db-seed backup restore clean

# Carregar variÃ¡veis do .env
include .env.production
export

# Definir imagem
IMAGE_NAME := $(DOCKER_USERNAME)/chatwoot:latest

help: ## Mostrar ajuda
	@echo "ğŸš€ Chatwoot Docker Deploy"
	@echo ""
	@echo "Comandos disponÃ­veis:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

setup: ## ConfiguraÃ§Ã£o inicial
	@echo "ğŸ“‹ ConfiguraÃ§Ã£o inicial..."
	@cp .env.production.template .env.production
	@echo "âœ… Configure o arquivo .env.production e execute 'make build'"

build: ## Build completo e deploy
	@chmod +x build-and-deploy.sh
	@./build-and-deploy.sh

quick-deploy: ## Deploy rÃ¡pido (sem build)
	@chmod +x quick-deploy.sh
	@./quick-deploy.sh

logs: ## Ver logs de todos os serviÃ§os
	@docker-compose -f docker-compose.production.yml logs -f

logs-app: ## Ver logs apenas do app
	@docker-compose -f docker-compose.production.yml logs -f chatwoot

logs-sidekiq: ## Ver logs do Sidekiq
	@docker-compose -f docker-compose.production.yml logs -f sidekiq

status: ## Status dos serviÃ§os
	@docker-compose -f docker-compose.production.yml ps

shell: ## Shell no container principal
	@docker exec -it chatwoot-app /bin/sh

shell-rails: ## Console Rails
	@docker exec -it chatwoot-app bundle exec rails console

db-migrate: ## Executar migrations
	@echo "ğŸ—„ï¸ Executando migrations..."
	@docker exec chatwoot-app bundle exec rails db:create db:migrate

db-seed: ## Popular banco com dados iniciais
	@echo "ğŸŒ± Populando banco..."
	@docker exec chatwoot-app bundle exec rails db:seed

db-reset: ## Reset completo do banco (CUIDADO!)
	@echo "âš ï¸  CUIDADO: Isso apagarÃ¡ todos os dados!"
	@read -p "Digite 'CONFIRMAR' para continuar: " confirm && [ "$$confirm" = "CONFIRMAR" ]
	@docker exec chatwoot-app bundle exec rails db:drop db:create db:migrate db:seed

backup: ## Backup do banco de dados
	@echo "ğŸ’¾ Fazendo backup..."
	@mkdir -p backups
	@docker exec chatwoot-postgres pg_dump -U $(POSTGRES_USER) $(POSTGRES_DB) > backups/backup-$(shell date +%Y%m%d-%H%M%S).sql
	@echo "âœ… Backup salvo em backups/"

restore: ## Restaurar backup (especificar BACKUP_FILE=arquivo.sql)
	@if [ -z "$(BACKUP_FILE)" ]; then echo "âŒ Especifique BACKUP_FILE=arquivo.sql"; exit 1; fi
	@echo "ğŸ“¥ Restaurando backup $(BACKUP_FILE)..."
	@docker exec -i chatwoot-postgres psql -U $(POSTGRES_USER) -d $(POSTGRES_DB) < $(BACKUP_FILE)

stop: ## Parar todos os serviÃ§os
	@docker-compose -f docker-compose.production.yml down

restart: ## Reiniciar todos os serviÃ§os
	@docker-compose -f docker-compose.production.yml restart

update: ## Atualizar imagem e reiniciar
	@echo "ğŸ”„ Atualizando..."
	@docker-compose -f docker-compose.production.yml pull
	@docker-compose -f docker-compose.production.yml up -d

clean: ## Limpar containers e volumes nÃ£o utilizados
	@echo "ğŸ§¹ Limpando..."
	@docker system prune -f
	@docker volume prune -f

clean-all: ## Limpar TUDO (CUIDADO!)
	@echo "âš ï¸  CUIDADO: Isso removerÃ¡ TODOS os dados!"
	@read -p "Digite 'CONFIRMAR' para continuar: " confirm && [ "$$confirm" = "CONFIRMAR" ]
	@docker-compose -f docker-compose.production.yml down -v
	@docker system prune -af
	@docker volume prune -f

health: ## Verificar saÃºde dos serviÃ§os
	@echo "ğŸ” Verificando serviÃ§os..."
	@docker-compose -f docker-compose.production.yml ps
	@echo ""
	@echo "ğŸŒ Testando URL..."
	@curl -f https://$(DOMAIN)/health && echo "âœ… OK" || echo "âŒ Falhou"

ssl-check: ## Verificar certificado SSL
	@echo "ğŸ”’ Verificando SSL para $(DOMAIN)..."
	@echo | openssl s_client -connect $(DOMAIN):443 -servername $(DOMAIN) 2>/dev/null | openssl x509 -noout -dates

deploy-info: ## InformaÃ§Ãµes do deploy
	@echo "ğŸ“‹ INFORMAÃ‡Ã•ES DO DEPLOY"
	@echo "========================"
	@echo "ğŸŒ URL: https://$(DOMAIN)"
	@echo "ğŸ“Š Traefik: http://traefik.$(DOMAIN):8080"
	@echo "ğŸ³ Imagem: $(IMAGE_NAME)"
	@echo "ğŸ—„ï¸ Banco: $(POSTGRES_DB)"
	@echo ""
	@echo "ğŸ“š COMANDOS ÃšTEIS:"
	@echo "make logs          - Ver logs"
	@echo "make shell         - Shell no app"
	@echo "make db-migrate    - Executar migrations"
	@echo "make backup        - Backup do banco"